name: Release
on:
  release:
    types: [published]
    tags:
      - '*.*.*'      # 1.0.0 など 3つの数字がドットで繋がっている形式
permissions:
  contents: write
env:
  packageName: "net.kunkun.editorwallpaper"
jobs:
  # This job triggers a workflow in a different repository using the Actions API.
  # It requires a personal access token stored in this repo's secrets (see README below).
  trigger-external-workflow:
    name: Trigger external repo workflow
    runs-on: ubuntu-latest
    steps:
      - name: Trigger workflow in another repository
        # Set these env vars to the target repository you want to trigger
        env:
          OWNER: kunkun5001            # owner of the target repo
          REPO: vpm-repository         # target repo name
          WORKFLOW_FILE: "build-listing.yml"   # the workflow file name (or id) in the target repo
        run: |
          # Read PAT from secrets inside the run to avoid linter/context issues
          PAT="${{ secrets.REPO_DISPATCH_TOKEN }}"
          if [ -z "$PAT" ]; then
            echo "ERROR: secret REPO_DISPATCH_TOKEN is not set in this repository. Create a personal access token (repo scope) and store it as REPO_DISPATCH_TOKEN in repo Secrets." >&2
            exit 1
          fi
          REF="${GITHUB_REF}"
          # URL-encode the workflow file name to handle spaces
          WORKFLOW_FILE_ENCODED=$(python3 -c "import urllib.parse,sys;print(urllib.parse.quote(sys.argv[1], safe=''))" "$WORKFLOW_FILE")
          API_URL="https://api.github.com/repos/${OWNER}/${REPO}/actions/workflows/${WORKFLOW_FILE_ENCODED}/dispatches"
          echo "Triggering workflow in ${OWNER}/${REPO} -> ${WORKFLOW_FILE} (encoded: ${WORKFLOW_FILE_ENCODED}) at ref ${REF}"
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X POST "$API_URL" \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: token ${PAT}" \
            -d "{\"ref\": \"${REF#refs/heads/}\", \"inputs\": { \"packageName\": \"${PACKAGE_NAME}\", \"source_repo\": \"${GITHUB_REPOSITORY}\" } }")
          echo "GitHub API response code: $HTTP_CODE"
          if [ "$HTTP_CODE" -ge 400 ]; then
            echo "Failed to trigger workflow (HTTP $HTTP_CODE)" >&2
            exit 1
          fi

  # Note: The built-in GITHUB_TOKEN cannot trigger workflows in other repositories.
  # Create a Personal Access Token (classic) with `repo` scope and add it to this repo
  # as the secret `REPO_DISPATCH_TOKEN` before using this job.

  